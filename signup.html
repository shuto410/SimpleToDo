<!DOCTYPE html>

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <!-- jQuery読み込み -->
    <script src="jquery-3.2.1.min.js"></script>
    <title>signup</title>

    <body>

        <form>
            <label>メールアドレス</label>
            <input type='text' id="mail_regist" maxlength='50' name='mail' />
            <span id='mail_info'></span><br />

            <label>パスワード</label>
            <input type='password' maxlength='16' name='pass' id="password" />
            <span id='pass_info'></span><br />

            
            <label>パスワード(確認)</label>
            <input type='password' maxlength='16' name='pass_conf' id="confirm_password" />

            <span id="pass_confirm_message"></span><br />
            <span class='fieldname'>&nbsp;</span>

            <button type="button" id='submit'>登録</button>
        </form>

        <script>
            var isMailComplete = false;
            var isPassComplete = false;
            
            
            //メールアドレス入力後チェック
            $(function() {
                $('#mail_regist').blur(function() {
                    fetch('checkMailAddress.php', {
                        method:  'POST',
                        body:    'mail=' + $('#mail_regist').val(),
                        headers: new Headers({
                            'Content-type': 'application/x-www-form-urlencoded'
                        })
                    }).then(function(response) {
                        return response.json();
                    }).then(function(json) {
                        if (json.isMailAddress == false) {
                            //alert($('#info').text());
                            $('#mail_info').html('正しい形式ではありません。');
                        } else if (json.isUsed) {
                            $('#mail_info').html('このメールアドレスは使用されています。');
                        } else {
                            $('#mail_info').html('&#10003');
                            isMailComplete = true;
                        }
                    })
                })
            })
            
            
            $(function() {
                $('#password').blur(function() {
                    var pass = $('#password').val();      //パスワードの入力値を取得
                    if(pass == "") return;
                    if(pass.length < 8){
                        $('#pass_info').html('パスワードは8文字以上に設定してください');
                    }
                    else if(pass.search(/[a-zA-Z]/) == -1 || pass.search(/[0-9]/) == -1) {
                        $('#pass_info').html('パスワードには英字と数字を両方含む必要があります。');
                    }
                    else{
                        $('#pass_info').html('&#10003');
                    }
                })
            })
            
            $(function(){
                $('#confirm_password').blur(function(){
                    var pass = $('#password').val();
                    var pass_confirm = $('#confirm_password').val();
                    if(pass_confirm == "") return;
                    if(pass != pass_confirm){
                        $('#pass_confirm_message').html('パスワードが一致しません。');
                    }
                    else{
                        $('#pass_confirm_message').html('&#10003;');
                        isPassComplete = true;
                    }
                })
            })
            
            $(function(){
                $('#submit').click(function(){
                    if(!isMailComplete || !isPassComplete){
                        alert("retry!");
                        return;
                    }
                    fetch("registAccount.php", {
                        method: 'POST',
                        body:   'mail=' + $('#mail_regist').val() + '&pass=' + $('#password').val(),
                        headers: new Headers({
                            'Content-type': 'application/x-www-form-urlencoded'
                        })
                    }).then(function(response){
                        return response.json();
                    }).then(function(json){
                        if(json.result = true){
                            window.location.href = 'service.html';
                        }
                        else{
                            alert("failed!");
                        }
                    })
                })
            })

        </script>


    </body>
</head>
